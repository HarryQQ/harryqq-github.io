---
title: 微信支付流程
date: 2018-04-21 13:37:46
tags:
---
#### 手机浏览器唤起原生app

[参考](https://www.cnblogs.com/shadajin/p/5724117.html)

<a href="schemeUrl">唤醒你的APP</a>

location.href = '自定义 URL scheme';

微信屏蔽了调起接口，但可以通过应用宝唤起，未安装提示下载

#### 公众号微信支付流程
[参考](https://pay.weixin.qq.com/wiki/doc/api/jsapi.php?chapter=7_3)
- 微信商户平台（pay.weixin.qq.com）设置您的公众号支付支付目录
- 设置授权域名
- 前端请求后端支付接口（带上商品id）
- 后端生成商户订单，后端再请求微信支付系统调用统一下单api
- 微信支付系统生成预付单，将预付id返回给后端。
- 后端用预付id生成jsapi支付参数并签名返回给前端。
- 前端用拿到支付参数通过jsapi请求微信支付系统。getBrandWCPayRequest
- 微信支付系统检查参数合法和授权域权限，返回检查结果，弹起输入支付密码。（自动）
- 前端页面支付完向微信支付系统提交支付授权（自动）
- 向微信支付系统通知后端和前端用户支付结果

    > 请求后端，获取到支付参数，判断页面是否加载完jsapi的WeixinJSBridge，加载完就可以调起


     try {
     // 获取支付参数和加载WeixinJSBridge
      const params = await wxPayApi({product_id: id, type})
      if (typeof WeixinJSBridge === 'undefined') {
        if (document.addEventListener) {
          document.addEventListener('WeixinJSBridgeReady', this.onBridgeReady(params), false)
        } else if (document.attachEvent) {
          document.attachEvent('WeixinJSBridgeReady', this.onBridgeReady(params))
          document.attachEvent('onWeixinJSBridgeReady', this.onBridgeReady(params))
        }
      } else {
        this.onBridgeReady(params)
      }
    } catch (e) {
      this.$vux.toast.text(e.message, 'middle')
    }

    onBridgeReady (params) {
      let self = this
      /*eslint-disable*/
      WeixinJSBridge.invoke('getBrandWCPayRequest', {
          appId: params.appId,
          timeStamp: params.timeStamp,
          nonceStr: params.nonceStr,
          package: params.package,
          signType: params.signType,
          paySign: params.paySign
        },
        function (res) {
          // 使用以上方式判断前端返回,微信团队郑重提示：res.err_msg将在用户支付成功后返回    ok，但并不保证它绝对可靠。
          if (res.err_msg === 'get_brand_wcpay_request:ok') {
            self.$vux.toast.text('已购买成功', 'middle')
            location.href = location.href.split('?')[0] + '?' + new Date().getTime() // todo 假如原来有参数需要换种写法
          } else if (res.err_msg === 'get_brand_wcpay_request:cancel') {
            self.$vux.toast.text('已取消支付', 'middle')
          } else if (res.err_msg === 'get_brand_wcpay_request:fail') {
            self.$vux.toast.text('支付失败，请重新购买', 'middle')
          }
        }
      )
    }

#### h5页面调起支付
[参考](https://pay.weixin.qq.com/wiki/doc/api/H5.php?chapter=15_4)
- 前端请求后端支付接口（带上商品id）
- 后端生成商户订单，后端再请求微信支付系统调用统一下单api。
- 微信支付系统返回后端一个url，后端将url返回前端
- 前端跳转到这个url去到微信的中间页（url带上redirect_url可以自定义回调页面，默认是发起支付页面）
- 中间页不管支付成功或取消，都会跳转（回调页或支付发起页面）
- 商户在展示页面，引导用户主动发起支付结果的查询
- 商户后台判断是否接到收微信侧的支付结果通知，如没有，后台调用我们的订单查询接口确认订单状态并展示给用户


    try {
        const resp = await wxBrowserPayApi({product_id: id, type})
        this.closeEvent()
        const encodeUrl = encodeURI(window.location.href)
        window.location.href = `${resp.mweb_url}&redirect_url=${encodeUrl}`
    } catch (e) {
        this.$vux.toast.text(e.message, 'middle')
    }
